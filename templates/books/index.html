{% extends "base.html" %}

{% block title %}æ›¸ç±ä¸€è¦§{% endblock %}

{% block content %}
<div class="container">
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-md-4">
                    {{ form.keyword.label(class="form-label") }}
                    {{ form.keyword(class="form-control", placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã€è‘—è€…ã€ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢") }}
                </div>
                <div class="col-md-3">
                    {{ form.category1.label(class="form-label") }}
                    {{ form.category1(class="form-select", id="category1") }}
                </div>
                <div class="col-md-3">
                    {{ form.category2.label(class="form-label") }}
                    {{ form.category2(class="form-select", id="category2") }}
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-search"></i> æ¤œç´¢
                    </button>
                    <a href="{{ url_for('books.index') }}" class="btn btn-secondary">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>æ›¸ç±ä¸€è¦§</h2>
        {% if current_user.is_admin %}
        <div>
            <a href="{{ url_for('books.add') }}" class="btn btn-success me-2">
                <i class="fas fa-plus"></i> æ›¸ç±ç™»éŒ²
            </a>
            <a href="{{ url_for('books.import_books') }}" class="btn btn-primary">
                <i class="fas fa-file-import"></i> ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
            </a>
        </div>
        {% endif %}
    </div>

    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead>
                <tr>
                    <th>ã‚¿ã‚¤ãƒˆãƒ«</th>
                    <th>è‘—è€…</th>
                    <th>åˆ†é¡</th>
                    <th>é…ç½®å ´æ‰€</th>
                    <th>çŠ¶æ…‹</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr>
                    <td>{{ book.title }}</td>
                    <td>{{ book.author }}</td>
                    <td>
                        {{ book.category1 }}
                        {% if book.category2 %}
                        <br>
                        <small class="text-muted">{{ book.category2 }}</small>
                        {% endif %}
                    </td>
                    <td>{{ book.location }}</td>
                    <td>
                        {% if book.borrower_id %}
                        <span class="badge bg-danger">è²¸å‡ºä¸­</span>
                        {% else %}
                        <span class="badge bg-success">åˆ©ç”¨å¯èƒ½</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('books.book_detail', book_id=book.id) }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-info-circle"></i> è©³ç´°
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center">
                        <div class="alert alert-info mb-0">
                            æ¤œç´¢æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹æ›¸ç±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ JavaScript loaded and DOM ready');
    const category1Select = document.getElementById('category1');
    const category2Select = document.getElementById('category2');
    
    console.log('ğŸ” Elements found:', {
        category1: category1Select,
        category2: category2Select
    });
    
    if (!category1Select || !category2Select) {
        console.error('âŒ Category select elements not found!');
        return; // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
    }
    
    console.log('âœ… Both elements found, setting up event listener');
    
    // ç¬¬1åˆ†é¡ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã®å‡¦ç†
    category1Select.addEventListener('change', function() {
        const selectedCategory1 = this.value;
        console.log('ğŸ“ Category1 changed to:', selectedCategory1);
        
        // ç¬¬2åˆ†é¡ã‚’ãƒªã‚»ãƒƒãƒˆ
        category2Select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        if (selectedCategory1 === '') {
            // ç¬¬1åˆ†é¡ãŒæœªé¸æŠã®å ´åˆã¯ç¬¬2åˆ†é¡ã‚‚ç„¡åŠ¹åŒ–
            category2Select.disabled = true;
            console.log('ğŸš« Category1 is empty, disabling category2');
            return;
        }
        
        // ç¬¬2åˆ†é¡ã‚’æœ‰åŠ¹åŒ–
        category2Select.disabled = false;
        
        // APIã‹ã‚‰ç¬¬2åˆ†é¡ã®é¸æŠè‚¢ã‚’å–å¾—
        const apiUrl = `/api/categories/${encodeURIComponent(selectedCategory1)}`;
        console.log('ğŸŒ Fetching from API URL:', apiUrl);
        
        fetch(apiUrl)
            .then(response => {
                console.log('ğŸ“¡ API Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('ğŸ“¦ Received data:', data);
                console.log('ğŸ“Š Data length:', data.length);
                
                // å–å¾—ã—ãŸé¸æŠè‚¢ã‚’ç¬¬2åˆ†é¡ã«è¿½åŠ 
                data.forEach((option, index) => {
                    console.log(`â• Adding option ${index + 1}:`, option);
                    const optionElement = document.createElement('option');
                    optionElement.value = option.value;
                    optionElement.textContent = option.text;
                    category2Select.appendChild(optionElement);
                });
                
                console.log('âœ… Category2 options updated successfully');
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ç¬¬2åˆ†é¡ã®å€¤ã‚’å–å¾—ã—ã¦è¨­å®š
                const urlParams = new URLSearchParams(window.location.search);
                const category2Value = urlParams.get('category2');
                if (category2Value) {
                    category2Select.value = category2Value;
                    console.log('ğŸ”„ Set category2 from URL param:', category2Value);
                }
            })
            .catch(error => {
                console.error('âŒ Error fetching category2 options:', error);
                // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const errorOption = document.createElement('option');
                errorOption.value = '';
                errorOption.textContent = 'é¸æŠè‚¢ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
                category2Select.appendChild(errorOption);
            });
    });
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç¬¬1åˆ†é¡ãŒæ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®å‡¦ç†
    console.log('ğŸ” Initial category1 value:', category1Select.value);
    if (category1Select.value !== '') {
        console.log('ğŸ”„ Dispatching change event for initial value');
        category1Select.dispatchEvent(new Event('change'));
    } else {
        // ç¬¬1åˆ†é¡ãŒæœªé¸æŠã®å ´åˆã¯ç¬¬2åˆ†é¡ã‚’ç„¡åŠ¹åŒ–
        console.log('ğŸš« No initial category1 value, disabling category2');
        category2Select.disabled = true;
    }
});
</script>
{% endblock %}